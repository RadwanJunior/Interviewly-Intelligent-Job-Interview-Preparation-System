{
  "nodes": [
    {
      "parameters": {
        "jsCode": "const ctx = execution.staticData.interview || {};\n\nreturn {\n  json: {\n    ...$json,   // current item\n    ...ctx      // inject stored company/job_title/etc\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [496, -80],
      "id": "ea9e67d4-4587-47f0-9ef4-b1a960a9ee18",
      "name": "Merge Interview Context3"
    },
    {
      "parameters": {
        "jsCode": "const ctx = execution.staticData.interview || {};\n\nreturn {\n  json: {\n    ...$json,   // current item\n    ...ctx      // inject stored company/job_title/etc\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2064, 112],
      "id": "cd2195eb-ae1d-4c6f-9300-97da3b97770d",
      "name": "Merge Interview Context2"
    },
    {
      "parameters": {
        "jsCode": "const ctx = execution.staticData.interview || {};\n\nreturn {\n  json: {\n    ...$json,   // current item\n    ...ctx      // inject stored company/job_title/etc\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3184, 112],
      "id": "6f4de19f-8bb3-4101-950a-4137a730e27b",
      "name": "Merge Interview Context1"
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.item.json;\nconst urls = inputData.urls || [];\n\nif (!Array.isArray(urls) || urls.length === 0) {\n  return []; // Return nothing if there are no URLs to process\n}\n\n// Map each url to its own item.\n// Crucially, copy ALL data from the original item (`...inputData`)\n// and then set the specific 'url' for the new item.\nreturn urls.map(url => ({\n  json: {\n    ...inputData, // This copies company, job_title, resume, etc.\n    url: url      // Overwrite/set the url for this specific new item\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [944, 112],
      "id": "d2d910f3-e704-4361-8eb8-528a119000ee",
      "name": "Create URL Items"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-embedding-001:embedContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  \"model\": \"embedding-001\",\n  \"content\": {\n    \"parts\": [\n      {\n        \"text\": $json.query_text\n      }\n    ]\n  }\n}) }}",
        "options": {}
      },
      "name": "Generate Gemini Embedding",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [-1072, 16],
      "id": "94ac130f-5be6-4b60-a8c7-da1b9415eeb3",
      "credentials": {
        "googlePalmApi": {
          "id": "JflTtghJYyMdjigf",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Format Results & Build Prompt (Run once for all items)\n// Expected incoming JSON fields: resume, job_title, job_description, company, searchResults (array)\n// searchResults items expected to have: content, doc_type, similarity (float)\n\ntry {\n  const resume = $json.resume || '';\n  const job_title = $json.job_title || '';\n  const job_description = $json.job_description || '';\n  const company = $json.company || '';\n  const rawResults = $json.searchResults || [];\n\n  // Defensive: ensure array\n  const results = Array.isArray(rawResults) ? rawResults : [];\n\n  // Sort by similarity desc and take top N (choose 5)\n  const topN = 5;\n  const top = results\n    .slice()\n    .sort((a,b) => (b.similarity || 0) - (a.similarity || 0))\n    .slice(0, topN);\n\n  // Build a compact context block: each item on its own paragraph\n  const contexts = top.map((r, i) => {\n    const type = r.doc_type || 'context';\n    const content = (r.content || '').trim();\n    // Limit snippet length to 1000 chars for prompt safety\n    const snippet = content.length > 1000 ? content.slice(0,1000) + '...' : content;\n    return `${i+1}. [${type}] ${snippet}`.trim();\n  });\n\n  // Build the enhanced prompt (clean)\n  const enhanced_prompt = [\n    `You are an AI interviewer assistant.`,\n    `Company: ${company}`,\n    `Job Title: ${job_title}`,\n    ``,\n    `Candidate Resume:`,\n    resume,\n    ``,\n    `Job Description:`,\n    job_description,\n    ``,\n    `Relevant context (retrieved from knowledge base):`,\n    contexts.length ? contexts.join('\\n\\n') : 'No additional context available.',\n    ``,\n    `Instructions: Ask a sequence of challenging but fair interview questions that assess both technical skills and cultural fit. Mix technical, behavioral, and company-specific questions. Ask follow-ups when appropriate.`\n  ].join('\\n');\n\n  // Return: include both structured contexts array and prompt string\n  return {\n    json: {\n      interview_id: $json.interview_id || null,\n      company,\n      job_title,\n      resume,\n      job_description,\n      contexts, // array of short strings (no similarity scores)\n      enhanced_prompt\n    }\n  };\n} catch (err) {\n  // On error, return a payload indicating failure so downstream nodes can detect\n  return {\n    json: {\n      error: true,\n      error_message: err.message,\n      debug: (err.stack || '').slice(0,1000)\n    }\n  };\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [720, -80],
      "id": "25f00f96-a4ec-49ff-8426-2ff38b38155d",
      "name": "Format Results & Build Prompt"
    },
    {
      "parameters": {
        "jsCode": "const resume = $json.resume || '';\nconst jobTitle = $json.job_title || '';\nconst company = $json.company || '';\n\n// Extract top lines + skills from resume\nconst lines = resume.split(/\\r?\\n/).map(l => l.trim()).filter(Boolean);\nconst topLines = lines.slice(0, 5).join(' ');\nconst skillsMatch = resume.match(/skills[:\\s]*([^\\n\\r]{1,300})/i);\nconst skills = skillsMatch ? skillsMatch[1].split(/[,;|�]/).slice(0,10).join(', ') : '';\n\nconst query_text = `Job Title: ${jobTitle}\\nCompany: ${company}\\nSummary: ${topLines}\\nSkills: ${skills}`;\nreturn { json: { ...$json, query_text } };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1296, 16],
      "id": "76b5307c-b007-466f-8268-873e4ce8f9e5",
      "name": "Build Query Text"
    },
    {
      "parameters": {
        "jsCode": "const basePrompt = `You are an AI interviewer for ${$json.company || ''} interviewing a candidate for ${$json.job_title || ''}.\\n\\nCandidate Resume:\\n${$json.resume || ''}\\n\\nJob Description:\\n${$json.job_description || ''}`;\nlet enhanced = basePrompt;\nif ($json.companyInfo) enhanced += `\\n\\nCompany Info:\\n${$json.companyInfo}`;\nif ($json.roleRequirements) enhanced += `\\n\\nRole Requirements:\\n${$json.roleRequirements}`;\nif ($json.interviewQuestions) enhanced += `\\n\\nCommon Interview Questions:\\n${$json.interviewQuestions}`;\nif ($json.interviewProcess) enhanced += `\\n\\nInterview Process:\\n${$json.interviewProcess}`;\nif ($json.candidateAdvice) enhanced += `\\n\\nInterview Advice:\\n${$json.candidateAdvice}`;\nenhanced += \"\\n\\nInstructions:\\n1. Ask challenging but fair questions that assess both technical skills and cultural fit.\\n2. Mix of technical, behavioral, and company-specific questions.\\n3. Ask follow-up questions to dive deeper into candidate responses.\\n4. Be professional but conversational in your interview style.\";\nreturn { json: { enhanced_prompt: enhanced, interview_id: $json.interview_id } };"
      },
      "id": "bfc9ef97-228b-4815-9dfc-6633a4d49457",
      "name": "Build Enhanced Prompt1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4304, 112]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.item.json || $input.all().map(i=>i.json).flat();\n// If HTTP node returned an array, it's in item.json\nlet allItems = [];\nif (Array.isArray(items)) allItems = items;\nelse if (Array.isArray($input.all())) allItems = $input.all().map(i=>i.json).flat();\n\nconst contentByType = {};\nallItems.forEach(item => {\n� const t = item.doc_type || 'other';\n� if (!contentByType[t]) contentByType[t] = [];\n� contentByType[t].push(item.content);\n});\n\nreturn [{ json: {\n� interviewQuestions: (contentByType['interview_questions'] || []).join('\\n\\n'),\n� companyInfo: (contentByType['company_info'] || []).join('\\n\\n'),\n� roleRequirements: (contentByType['role_requirements'] || []).join('\\n\\n'),\n� interviewProcess: (contentByType['interview_process'] || []).join('\\n\\n'),\n� candidateAdvice: (contentByType['candidate_advice'] || []).join('\\n\\n')\n}}];"
      },
      "id": "46c19f35-ac98-4a96-83d3-f10a1c77297d",
      "name": "Process Retrieved Content1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4080, 112]
    },
    {
      "parameters": {
        "url": "=https://jdtuplcyczhtpljofwjg.supabase.co/rest/v1/context_documents",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "batch_id",
              "value": "={{ $json.batch_id }}"
            },
            {
              "name": "select",
              "value": "*"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "d0c8c6d9-6ee8-4a18-9942-fc2a09005d5a",
      "name": "Query Stored Contexts1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [3856, 112]
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "seconds"
      },
      "id": "f6c565ff-3dfd-4202-a77e-7e93740af398",
      "name": "Wait Between Requests1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [3632, 112],
      "webhookId": "722ffd3e-71d6-4688-940b-4027764389ed"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://jdtuplcyczhtpljofwjg.supabase.co/rest/v1/context_documents?on_conflict=content_hash",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "=={{\n  {\n    \"content\": $json.content,\n    \"doc_type\": $json.doc_type,\n    \"source_url\": $json.source_url || 'unknown URL',\n    \"company\": $json.company,\n    \"job_title\": $json.job_title,\n    \"batch_id\": $json.batch_id,\n    \"content_hash\": $json.content_hash,\n    \"embedding_1536\": $json.embedding\n  }\n}}\n",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "3b210cdd-0243-4273-aba3-a39ba94b5228",
      "name": "Upsert Content to Supabase1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [3408, 112]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Extract Doc Embedding - runs per item\nconst resp = $input.item.json || {};\nlet embedding = resp.embedding ?? resp.body?.embedding ?? resp.body?.embeddings?.[0]?.values ?? resp.body?.candidates?.[0]?.content?.parts?.[0]?.embedding ?? null;\n\nif (embedding && embedding.values) embedding = embedding.values;\nif (typeof embedding === 'string') {\n  try { embedding = JSON.parse(embedding); } catch (e) {}\n}\n\nif (!Array.isArray(embedding)) {\n  console.log('Embed raw body (truncated):', JSON.stringify(resp).slice(0,2000));\n  throw new Error('Extract Doc Embedding: embedding not found or not an array');\n}\n\nreturn { json: { ...$json, embedding } };\n"
      },
      "id": "a6aa4328-120f-4c8e-917e-c6cc8c4b619f",
      "name": "Extract Doc Embedding2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2736, 112]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1/models/embedding-001:embedContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "=={{ ({\n  \"model\": \"embedding-001\",\n  \"content\": {\n    \"parts\": [\n      { \"text\": $json.doc_text }\n    ]\n  },\n  \"config\": { \"output_dimensionality\": 1536 }\n}) }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "fb0e3b3d-867d-4905-b262-4b59ccb4f806",
      "name": "Generate Doc Embedding1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [2512, 112],
      "credentials": {
        "googlePalmApi": {
          "id": "JflTtghJYyMdjigf",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Build doc_text for embedding per chunk (runs per item)\nconst content = ($json.content || '').trim();\nconst company = $json.company || '';\nconst jobTitle = $json.job_title || '';\nconst safeContent = content.length > 10000 ? content.slice(0, 10000) : content; // limit size\nconst doc_text = `Company: ${company}\\nJob Title: ${jobTitle}\\nContent: ${safeContent}`.trim();\nreturn { json: { ...$json, doc_text } };"
      },
      "id": "3d056caf-4620-4c72-8b54-6c1d1d3d85e4",
      "name": "Build Doc Text2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2288, 112]
    },
    {
      "parameters": {
        "jsCode": "// Expand Extracted Content - takes the current item (with extractedContent array)\n// and returns one output item per extracted object\n\nconst arr = $json.extractedContent || [];\nif (!Array.isArray(arr) || arr.length === 0) {\n  // nothing to expand — return an empty array (no outputs)\n  return [];\n}\n\n// Map each extracted object into its own n8n item; preserve parent metadata\nreturn arr.map(item => ({\n  json: {\n    content: item.content || '',\n    doc_type: item.doc_type || item.docType || 'other',\n    source_url: item.source_url || $json.url || null,\n    company: $json.company || null,\n    job_title: $json.job_title || null,\n    batch_id: $json.batchId || $json.batch_id || null,\n    interview_id: $json.interview_id || null\n  }\n}));"
      },
      "id": "3c87d44e-8b8e-4aea-b665-230bccc904e4",
      "name": "Expand Extracted Content1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1616, 112]
    },
    {
      "parameters": {
        "operation": "publish",
        "channel": "interviewly:prompt-ready",
        "messageData": "=={{ JSON.stringify({ interview_id: $json.interview_id, enhanced_prompt: $json.enhanced_prompt, source: 'new_data' }) }}"
      },
      "id": "76064bfc-7953-45df-a77c-c47a0dba6d41",
      "name": "Notify Enhanced Prompt (Redis)",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [4528, 112],
      "credentials": {
        "redis": {
          "id": "bWGrVbuj0Hi8Mhlb",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Compute SHA256 content hash (per item)\nconst crypto = require('crypto');\nconst docText = $json.doc_text || $json.content || '';\nconst hash = crypto.createHash('sha256').update(docText).digest('hex');\nreturn { json: { ...$json, content_hash: hash } };"
      },
      "id": "dbeabd08-2197-46b6-87c5-60f9f99f4fac",
      "name": "Compute Content Hash",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2960, 112]
    },
    {
      "parameters": {
        "jsCode": "const allFinalItems = [];\nconst chunkSize = 1000;\nconst overlap = 200;\n\n// Loop over every item that came into this node.\n// '$items' is an array of all incoming items.\nfor (const item of $items) {\n  const text = (item.json.content || '').trim();\n\n  // If there's no text, pass the original item through without changing it.\n  if (!text) {\n    allFinalItems.push(item);\n    continue; // Move to the next item\n  }\n\n  const chunks = [];\n  for (let i = 0; i < text.length; i += (chunkSize - overlap)) {\n    const piece = text.slice(i, i + chunkSize).trim();\n    if (piece) {\n      chunks.push(piece);\n    }\n  }\n\n  // If content was present but no chunks were made, pass the original item through.\n  if (chunks.length === 0) {\n    allFinalItems.push(item);\n  } else {\n    // We have chunks. Create a new n8n item for EACH chunk.\n    for (const chunkContent of chunks) {\n      // Create a new item by copying metadata from the original item,\n      // and setting the new chunk as the content.\n      const newItem = {\n        json: {\n          ...item.json,\n          content: chunkContent\n        }\n      };\n      allFinalItems.push(newItem);\n    }\n  }\n}\n\n// Return the final, complete list of all items and chunks.\nreturn allFinalItems;"
      },
      "id": "53cf08d0-4a98-41f9-a93a-24570ca68411",
      "name": "Chunk Content (optional)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1840, 112]
    },
    {
      "parameters": {
        "operation": "publish",
        "channel": "interviewly:prompt-ready",
        "messageData": "==={{ JSON.stringify({ interview_id: $json.interview_id, enhanced_prompt: $json.enhanced_prompt, source: 'existing_data' }) }}\n"
      },
      "name": "Notify Enhanced Prompt (Existing)1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [944, -80],
      "id": "d2a41980-4aea-46d9-87ed-ee32be1db0f6",
      "credentials": {
        "redis": {
          "id": "bWGrVbuj0Hi8Mhlb",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "let extractedContent = [];\n// The raw response from the Gemini HTTP node is in the 'body' property\nconst geminiResponse = $json;\nconst currentUrl = $input.item.json.url || 'unknown URL';\n\ntry {\n  // 1. Safely access the text content from the Gemini response\n  let jsonString = geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text;\n\n  if (jsonString && typeof jsonString === 'string') {\n    // 2. Clean the string: remove markdown wrappers and trim whitespace.\n    // This makes it more robust against common LLM formatting habits.\n    jsonString = jsonString.trim().replace(/^```json/, '').replace(/```$/, '').trim();\n\n    // 3. Parse the cleaned string into a JavaScript object/array\n    const parsed = JSON.parse(jsonString);\n\n    // 4. Ensure the result is an array and add the source URL to each item\n    if (Array.isArray(parsed)) {\n      extractedContent = parsed.map(item => ({\n        ...item,\n        source_url: currentUrl\n      }));\n    } else if (parsed && typeof parsed === 'object') {\n      // If Gemini returned a single object instead of an array, wrap it in an array\n      extractedContent = [{ ...parsed, source_url: currentUrl }];\n    }\n  } else {\n    console.log(\"Warning: Could not find the JSON text string in the Gemini response for URL:\", currentUrl);\n  }\n} catch (err) {\n  // Log detailed errors for easier debugging in the future\n  console.log(\"CRITICAL ERROR: Failed to parse Gemini response for URL:\", currentUrl);\n  console.log(\"Error message:\", err.message);\n  // Also log the raw text that failed to parse so you can see why\n  console.log(\"Raw text that failed parsing:\", geminiResponse?.candidates?.[0]?.content?.parts?.[0]?.text);\n}\n\n// 5. Return a new, clean object containing ONLY the data the next nodes need.\n// We keep the original context fields and add the new 'extractedContent' array.\nreturn {\n  json: {\n    company: $input.item.json.company,\n    job_title: $input.item.json.job_title,\n    batchId: $input.item.json.batchId,\n    interview_id: $input.item.json.interview_id,\n    url: currentUrl,\n    extractedContent: extractedContent\n  }\n};"
      },
      "name": "Process Content1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1392, 112],
      "id": "c6bf1238-28d8-4957-8b3b-478017373f88"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googlePalmApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gemini-2.5-flash\",\n  \"contents\": [\n    {\n      \"role\": \"user\",\n      \"parts\": [\n        {\n          \"text\": \"URL: {{$json.url}}\\n\\nPlease analyze this page about {{$json.job_title || ''}} positions at {{$json.company || ''}} or similar companies.\\n\\nExtract the following information:\\n1. Interview questions specific to this role\\n2. Company culture insights\\n3. Required skills and qualifications\\n4. Interview process details\\n5. Tips from past interviewees\\n\\nFormat your response as a JSON array of objects with these properties:\\n- content: The extracted text\\n- doc_type: One of [\\\"interview_questions\\\", \\\"company_info\\\", \\\"role_requirements\\\", \\\"interview_process\\\", \\\"candidate_advice\\\"]\\n\\nOnly return valid JSON.  ensure that all special characters like newlines and double-quotes within the 'content' string value are properly JSON-escaped (e.g., \\\\n and \\\\\\\" )\"\n        }\n      ]\n    }\n  ],\n  \"system_instruction\": {\n    \"parts\": [\n      {\n        \"text\": \"You are a helpful assistant that extracts structured information from web content. Format your response as a JSON array of objects with these properties:\\n- content: The extracted text\\n- doc_type: One of [\\\"interview_questions\\\", \\\"company_info\\\", \\\"role_requirements\\\", \\\"interview_process\\\", \\\"candidate_advice\\\"]\\n\\nOnly return valid JSON. Crucially, ensure that all special characters like newlines and double-quotes within the 'content' string value are properly JSON-escaped (e.g., \\\\n and \\\\\\\" ).\"\n      }\n    ]\n  },\n  \"generation_config\": {\n    \"top_p\": 0.8,\n    \"top_k\": 40,\n    \"temperature\": 0.1,\n    \"response_mime_type\": \"application/json\"\n  }\n}\n",
        "options": {
          "response": {
            "response": {}
          }
        }
      },
      "name": "Extract Content With Gemini1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1168, 112],
      "id": "81be5583-e8a3-4bc2-bed3-ef9f6852edc6",
      "credentials": {
        "googlePalmApi": {
          "id": "JflTtghJYyMdjigf",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const incomingData = $input.item.json;\nconst results = incomingData.organic_results || [];\nconst webResults = results.filter(r => !r.link.includes('youtube.com'));\nconst urls = webResults.length > 0 ? webResults.map(r => r.link) : results.map(r => r.link);\n\nconst batchId = Date.now().toString();\n\nreturn {\n  json: {\n    ...incomingData, // Pass through all original data\n    urls: [...new Set(urls)].slice(0, 5),\n    urlCount: Math.min([...new Set(urls)].slice(0, 5).length, 5),\n    batchId\n  }\n};"
      },
      "name": "Extract URLs1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [720, 112],
      "id": "48405803-74c1-4f9e-9760-1aba41aaf76b"
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "={{ $json.company && $json.job_title ? \n        `${$json.company} interview questions for ${$json.job_title}` : \n        'interview questions' }}"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {}
      },
      "name": "Search SerpAPI1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [272, 112],
      "id": "e333787f-815f-4e78-94dc-09c857026433",
      "credentials": {
        "serpApi": {
          "id": "QGLoRswavOexgrGL",
          "name": "SerpAPI account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "{{ $json.hasQualityResults }}"
            }
          ]
        }
      },
      "name": "Branch Based on Results1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [48, 16],
      "id": "65422f11-b7a5-4530-b556-361ba01e942f"
    },
    {
      "parameters": {
        "jsCode": "// The DB results are now in the 'body' property because of the merge.\nconst results = $input.item.body || [];\nconst hasResults = results.length > 0;\nconst goodResults = results.filter(r => r.similarity > 0.8);\nconst hasQualityResults = goodResults.length >= 3;\n\nconst resultsByType = {};\nif (hasResults) {\n  results.forEach(item => {\n    const docType = item.doc_type || 'other';\n    if (!resultsByType[docType]) {\n      resultsByType[docType] = [];\n    }\n    resultsByType[docType].push(item);\n  });\n}\n\n// Now, we correctly merge the original data with the new evaluation.\nreturn {\n  json: {\n    ...$input.item.json, // Pass through all original data\n    searchResults: results,\n    resultsByType,\n    hasQualityResults\n  }\n};"
      },
      "name": "Evaluate Results1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [-176, 16],
      "id": "ab2af8e9-bab3-40e4-af89-eca67c8cc317"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://jdtuplcyczhtpljofwjg.supabase.co/rest/v1/rpc/match_context",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "query_embedding",
              "value": "={{ $json.embedding }}"
            },
            {
              "name": "similarity_threshold",
              "value": 0.7
            },
            {
              "name": "match_count",
              "value": 15
            },
            {
              "name": "p_company",
              "value": "={{ $json.company }}"
            },
            {
              "name": "p_job_title",
              "value": "={{ $json.job_title }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "name": "Search Vector DB1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [-624, 16],
      "id": "a3d4edc8-19f5-4a30-bf3d-e1dcc9063bfb",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "zRDKpsdTHaXcFpaq",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const embeddingResponse = $input.item.json.embedding;\n\n// Extract just the values array from the embedding object\nconst embedding = embeddingResponse && embeddingResponse.values \n  ? embeddingResponse.values   // If it has a 'values' property, use that\n  : embeddingResponse;         // Otherwise use as is\n\nreturn {\n  json: {\n    ...$json,\n    embedding\n  }\n};"
      },
      "name": "Extract Embedding1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [-848, 16],
      "id": "17b4a2d0-ba6d-48ee-9f3c-08753e4ec447"
    },
    {
      "parameters": {
        "jsCode": "const data = JSON.parse($input.item.json.message || '{}');\n\n// Output the parsed data to continue the workflow\nreturn {\n  json: data\n};"
      },
      "name": "Parse Request1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [-1520, 16],
      "id": "28ff10ef-af63-4e5f-b29b-350d95c47795"
    },
    {
      "parameters": {
        "channels": "interviewly:request-rag-test",
        "options": {}
      },
      "name": "Redis Trigger1",
      "type": "n8n-nodes-base.redisTrigger",
      "typeVersion": 1,
      "position": [-1744, 16],
      "id": "9384c02b-78aa-4630-b34b-92409dd3af82",
      "credentials": {
        "redis": {
          "id": "bWGrVbuj0Hi8Mhlb",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ Object.assign({}, $('Parse Request1').item.json, $json) }}\n",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [496, 112],
      "id": "114b5baa-5840-4d24-8f12-dfeb62c1e787",
      "name": "Re-add Interview Context"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ Object.assign({}, $('Parse Request1').item.json, $json) }}\n",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-400, 16],
      "id": "584ebca2-031e-4abe-a0ff-567da8668179",
      "name": "Re-add Context from DB"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ Object.assign({}, $('Parse Request1').item.json, $json) }}\n",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [272, -80],
      "id": "2e67aade-b70b-4734-bee6-dbb7279feeda",
      "name": "Re-add Interview Context1"
    }
  ],
  "connections": {
    "Merge Interview Context3": {
      "main": [
        [
          {
            "node": "Format Results & Build Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Interview Context2": {
      "main": [
        [
          {
            "node": "Build Doc Text2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Interview Context1": {
      "main": [
        [
          {
            "node": "Upsert Content to Supabase1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create URL Items": {
      "main": [
        [
          {
            "node": "Extract Content With Gemini1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Gemini Embedding": {
      "main": [
        [
          {
            "node": "Extract Embedding1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Results & Build Prompt": {
      "main": [
        [
          {
            "node": "Notify Enhanced Prompt (Existing)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Query Text": {
      "main": [
        [
          {
            "node": "Generate Gemini Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Enhanced Prompt1": {
      "main": [
        [
          {
            "node": "Notify Enhanced Prompt (Redis)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Retrieved Content1": {
      "main": [
        [
          {
            "node": "Build Enhanced Prompt1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Stored Contexts1": {
      "main": [
        [
          {
            "node": "Process Retrieved Content1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait Between Requests1": {
      "main": [
        [
          {
            "node": "Query Stored Contexts1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Content to Supabase1": {
      "main": [
        [
          {
            "node": "Wait Between Requests1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Doc Embedding2": {
      "main": [
        [
          {
            "node": "Compute Content Hash",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Doc Embedding1": {
      "main": [
        [
          {
            "node": "Extract Doc Embedding2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Doc Text2": {
      "main": [
        [
          {
            "node": "Generate Doc Embedding1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Expand Extracted Content1": {
      "main": [
        [
          {
            "node": "Chunk Content (optional)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compute Content Hash": {
      "main": [
        [
          {
            "node": "Merge Interview Context1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chunk Content (optional)": {
      "main": [
        [
          {
            "node": "Merge Interview Context2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Content1": {
      "main": [
        [
          {
            "node": "Expand Extracted Content1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Content With Gemini1": {
      "main": [
        [
          {
            "node": "Process Content1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract URLs1": {
      "main": [
        [
          {
            "node": "Create URL Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search SerpAPI1": {
      "main": [
        [
          {
            "node": "Re-add Interview Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Branch Based on Results1": {
      "main": [
        [
          {
            "node": "Re-add Interview Context1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Search SerpAPI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evaluate Results1": {
      "main": [
        [
          {
            "node": "Branch Based on Results1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Vector DB1": {
      "main": [
        [
          {
            "node": "Re-add Context from DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Embedding1": {
      "main": [
        [
          {
            "node": "Search Vector DB1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Request1": {
      "main": [
        [
          {
            "node": "Build Query Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Trigger1": {
      "main": [
        [
          {
            "node": "Parse Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Re-add Interview Context": {
      "main": [
        [
          {
            "node": "Extract URLs1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Re-add Context from DB": {
      "main": [
        [
          {
            "node": "Evaluate Results1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Re-add Interview Context1": {
      "main": [
        [
          {
            "node": "Merge Interview Context3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b4e6356340a5ffed9d47f619ec5d0af6291b4db54be51654b52515a0fce37134"
  }
}
